<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Episodes | South Park Hub</title>
  <meta name="description" content="Browse South Park episodes with basic filters and links." />
  <link rel="stylesheet" href="../Assets/css/site.css" />
  <script src="../Assets/js/layout.js" defer></script>
  <style>
    .list-toolbar { display:flex; gap:10px; align-items:center; margin: 16px 0; }
    .list-toolbar input { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #111825; color: var(--text); width: 260px; }
    .cards { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:16px; }
    .card { background: linear-gradient(180deg, var(--panel), #121725); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow: 0 8px 24px var(--shadow); }
    .card h3 { margin: 0 0 4px; font-size: 18px; }
    .card p { margin: 0; color: var(--muted); }
    .meta { margin-top:6px; font-size: 12px; color: var(--muted); }
    @media (max-width: 900px) { .cards { grid-template-columns: 1fr; } }
  </style>
  </head>
  <body>
  <a href="#main" class="skip-link">Skip to content</a>
  <header class="sp-header" role="banner">
    <nav class="sp-nav" aria-label="Primary">
      <a class="sp-brand" href="../index.html">South Park Hub</a>
      <div class="sp-links">
        <a class="sp-pill" href="../index.html">Home</a>
        <a class="sp-pill" href="../themes.html">Themes</a>
        <a class="sp-pill" href="../ideas.html">Ideas</a>
        <a class="sp-pill" href="../social.html">Social</a>
        <span class="sp-pill sp-active" aria-current="page">Episodes</span>
      </div>
    </nav>
  </header>

  <main id="main" class="sp-container" role="main">
    <h1 style="margin:0 0 10px">Episodes</h1>
    <p class="sp-muted">Quick browser of seasons and episodes. Filter by title or tag.</p>
    <div class="list-toolbar">
      <input id="q" type="search" placeholder="Search title, tag, character…" aria-label="Search episodes" />
    </div>

    <section class="cards" id="list" aria-live="polite"></section>
  </main>

  <footer class="sp-footer" role="contentinfo">
    <p><a href="../index.html">Back to Hub</a></p>
  </footer>

  <script>
  (async function() {
    const el = (sel) => document.querySelector(sel);
    const list = el('#list');
    const q = el('#q');
    let data = [];
    try {
      const res = await fetch('../Assets/data/episodes.json');
      data = await res.json();
    } catch (e) {
      list.innerHTML = '<p>Failed to load episodes.</p>';
      return;
    }

    function render(items) {
      if (!items || items.length === 0) {
        list.innerHTML = '<p>No episodes found.</p>';
        return;
      }
      list.innerHTML = items.map(ep => `
        <article class="card" id="${ep.id || ''}">
          <h3>S${ep.season}E${ep.episode} · ${ep.title}</h3>
          <p>${ep.synopsis || ''}</p>
          <div class="meta">Tags: ${(ep.tags||[]).join(', ')} · Air: ${ep.airDate || '—'}</div>
        </article>
      `).join('');
    }

    function matches(ep, term) {
      if (!term) return true;
      term = term.toLowerCase();
      return (
        (ep.title || '').toLowerCase().includes(term) ||
        (ep.synopsis || '').toLowerCase().includes(term) ||
        (ep.tags || []).some(t => (t||'').toLowerCase().includes(term)) ||
        (ep.characters || []).some(c => (c||'').toLowerCase().includes(term)) ||
        (ep.locations || []).some(l => (l||'').toLowerCase().includes(term)) ||
        ((`s${String(ep.season).padStart(2,'0')}e${String(ep.episode).padStart(2,'0')}`) === term) ||
        ((`s${String(ep.season).padStart(2,'0')}e${String(ep.episode).padStart(2,'0')}`) === term.replace('s','S').replace('e','E').toLowerCase())
      );
    }

    q.addEventListener('input', () => {
      const term = q.value.trim().toLowerCase();
      const items = data.filter(ep => matches(ep, term));
      render(items);
    });

    const params = new URLSearchParams(location.search);
    const preId = (params.get('id') || '').trim().toLowerCase();
    const preQ = (params.get('q') || '').trim();
    const preTag = (params.get('tag') || '').trim();
    if (preId) {
      const match = data.filter(ep => (ep.id||'').toLowerCase() === preId);
      render(match);
      if (match.length) {
        const el = document.getElementById(match[0].id);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    } else if (preQ) {
      q.value = preQ;
      q.dispatchEvent(new Event('input'));
    } else if (preTag) {
      q.value = preTag;
      q.dispatchEvent(new Event('input'));
    } else {
      render(data);
    }
    // Add Copy Link buttons and fix separators after render
    function enhanceEpisodeCards() {
      document.querySelectorAll('#list article.card').forEach(card => {
        const h3 = card.querySelector('h3');
        if (h3) h3.textContent = h3.textContent.replace('A', '·');
        const meta = card.querySelector('.meta');
        if (meta) meta.textContent = meta.textContent.replace('A', '·').replace(/["\?]+$/, '—');
        if (!card.querySelector('.copy-link')) {
          const id = card.id;
          const actions = document.createElement('div');
          actions.className = 'sp-card-actions';
          actions.style.marginTop = '8px';
          const btn = document.createElement('button');
          btn.className = 'sp-btn copy-link';
          btn.dataset.epid = id;
          btn.textContent = 'Copy Link';
          actions.appendChild(btn);
          card.appendChild(actions);
        }
      });
    }
    const mo = new MutationObserver(() => enhanceEpisodeCards());
    mo.observe(document.getElementById('list'), { childList: true });
    enhanceEpisodeCards();
    document.getElementById('list').addEventListener('click', async (e) => {
      const btn = e.target.closest('.copy-link');
      if (!btn) return;
      const id = btn.getAttribute('data-epid');
      const url = new URL(location.href);
      url.search = `?id=${encodeURIComponent(id)}`;
      try {
        await navigator.clipboard.writeText(url.href);
        const prev = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = prev, 1200);
      } catch { window.prompt('Copy link:', url.href); }
    });
  })();
  </script>
  </body>
  </html>
