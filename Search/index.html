<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Search | South Park Hub</title>
  <meta name="description" content="Global search across episodes, organizations, quotes, and timeline." />
  <link rel="stylesheet" href="../Assets/css/site.css" />
  <script src="../Assets/js/layout.js" defer></script>
  <style>
    .toolbar { display:flex; gap:10px; align-items:center; margin: 16px 0; flex-wrap: wrap; }
    .toolbar input, .toolbar select { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #111825; color: var(--text); }
    .toolbar input { width: 280px; }
    .cards { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:16px; }
    .card { background: linear-gradient(180deg, var(--panel), #121725); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow: 0 8px 24px var(--shadow); }
    .meta { font-size: 12px; color: var(--muted); }
    @media (max-width: 900px) { .cards { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Skip to content</a>
  <header class="sp-header" role="banner">
    <nav class="sp-nav" aria-label="Primary">
      <a class="sp-brand" href="../index.html">South Park Hub</a>
      <div class="sp-links">
        <a class="sp-pill" href="../index.html">Home</a>
        <a class="sp-pill" href="../themes.html">Themes</a>
        <a class="sp-pill" href="../ideas.html">Ideas</a>
        <a class="sp-pill" href="../social.html">Social</a>
        <span class="sp-pill sp-active" aria-current="page">Search</span>
      </div>
    </nav>
  </header>

  <main id="main" class="sp-container" role="main">
    <h1 style="margin:0 0 10px">Search</h1>
    <p class="sp-muted">Search episodes, organizations, quotes, timeline, characters, and locations.</p>

    <div class="toolbar">
      <input id="q" type="search" placeholder="Search everything…" aria-label="Global search" />
      <select id="type" aria-label="Filter by type">
        <option value="all" selected>All types</option>
        <option value="episode">Episodes</option>
        <option value="organization">Organizations</option>
        <option value="quote">Quotes</option>
        <option value="timeline">Timeline</option>
        <option value="character">Characters</option>
        <option value="location">Locations</option>
      </select>
    </div>

    <section id="list" class="cards" aria-live="polite"></section>
  </main>

  <footer class="sp-footer" role="contentinfo">
    <p><a href="../index.html">Back to Hub</a></p>
  </footer>

  <script>
  (async function() {
    const list = document.querySelector('#list');
    const q = document.querySelector('#q');
    const type = document.querySelector('#type');
    let episodes = [], orgs = [], quotes = [], timeline = [], characters = [], locations = [];
    try {
      episodes = await (await fetch('../Assets/data/episodes.json')).json();
    } catch {}
    try {
      orgs = await (await fetch('../Assets/data/organizations.json')).json();
    } catch {}
    try {
      quotes = await (await fetch('../Assets/data/quotes.json')).json();
    } catch {}
    try {
      timeline = await (await fetch('../Assets/data/timeline.json')).json();
    } catch {}
    try {
      characters = await (await fetch('../Assets/data/characters.json')).json();
    } catch {}
    try {
      locations = await (await fetch('../Assets/data/locations.json')).json();
    } catch {}

    function toItems() {
      const e = episodes.map(ep => ({
        type: 'episode',
        title: `S${ep.season}E${ep.episode} · ${ep.title}`,
        text: ep.synopsis || '',
        meta: `Tags: ${(ep.tags||[]).join(', ')}`,
        href: '../Episodes/index.html'
      }));
      const o = orgs.map(x => ({
        type: 'organization', title: x.name, text: x.notes || '', meta: `Type: ${x.type || '—'}`, href: '../Organizations/index.html'
      }));
      const qts = quotes.map(x => ({
        type: 'quote', title: `“${x.text}”`, text: (x.speakers||[]).join(', '), meta: x.episodeId ? `Episode: <a href="../Episodes/index.html?q=${encodeURIComponent(x.episodeId)}">${x.episodeId}</a>` : 'Episode: —', href: '../Quotes/index.html'
      }));
      const t = timeline.map(x => ({
        type: 'timeline', title: x.title, text: x.description || '', meta: `${x.date || '—'} · ${x.episodeId ? `<a href=\"../Episodes/index.html?q=${encodeURIComponent(x.episodeId)}\">${x.episodeId}</a>` : ''}`, href: '../Timeline/index.html'
      }));
      const slug = (s) => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
      const c = characters.map(x => ({
        type: 'character', title: x.name, text: x.bio || (x.aliases||[]).join(', '), meta: (x.tags||[]).join(', '), href: '../Wiki/page.html?type=character&id=' + encodeURIComponent(x.id || slug(x.name))
      }));
      const l = locations.map(x => ({
        type: 'location', title: x.name, text: x.description || '', meta: `${x.type || ''}${(x.tags&&x.tags.length)?' · '+x.tags.join(', '):''}`, href: '../Wiki/page.html?type=location&id=' + encodeURIComponent(x.id || slug(x.name))
      }));
      return [...e, ...o, ...qts, ...t, ...c, ...l];
    }

    const all = toItems();

    function matches(it, term) {
      if (!term) return true;
      term = term.toLowerCase();
      return (
        (it.title||'').toLowerCase().includes(term) ||
        (it.text||'').toLowerCase().includes(term) ||
        (it.meta||'').toLowerCase().includes(term)
      );
    }

    function render(items) {
      if (!items || items.length === 0) { list.innerHTML = '<p>No results.</p>'; return; }
      list.innerHTML = items.map(it => `
        <article class="card">
          <div class="meta">${it.type.toUpperCase()}</div>
          <h3 style="margin:2px 0 6px">${it.title}</h3>
          <p style="margin:0">${it.text}</p>
          <div class="meta" style="margin-top:6px">${it.meta}</div>
          <div class="sp-card-actions" style="margin-top:8px"><a class="sp-btn" href="${it.href}">Open</a></div>
        </article>
      `).join('');
    }

    function update() {
      const term = q.value.trim();
      const t = type.value;
      const filtered = all.filter(it => (t === 'all' || it.type === t) && matches(it, term));
      render(filtered);
    }

    q.addEventListener('input', update);
    type.addEventListener('change', update);
    update();
  })();
  </script>
</body>
</html>
